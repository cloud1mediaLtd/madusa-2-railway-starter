name: CI/CD Pipeline

on:
  push:
    branches:
      - main
  pull_request:
    branches:
      - main

jobs:
  # Validate backend builds successfully
  validate-backend:
    name: Validate Backend Build
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'yarn'
          cache-dependency-path: backend/yarn.lock

      - name: Install dependencies
        run: |
          cd backend
          yarn install --frozen-lockfile

      - name: Build backend
        run: |
          cd backend
          yarn build
        env:
          # Provide placeholder env vars for build validation
          DATABASE_URL: postgresql://localhost:5432/medusa_test
          JWT_SECRET: test_jwt_secret_for_ci_build_only
          COOKIE_SECRET: test_cookie_secret_for_ci_build_only

      - name: Validate build artifacts
        run: |
          if [ ! -d "backend/.medusa/server" ]; then
            echo "Backend build failed - .medusa/server directory not found"
            exit 1
          fi
          echo "âœ… Backend build successful"

  # Validate storefront builds successfully
  validate-storefront:
    name: Validate Storefront Build
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Enable Corepack
        run: corepack enable

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'yarn'
          cache-dependency-path: storefront/yarn.lock

      - name: Install dependencies
        run: |
          cd storefront
          yarn install --frozen-lockfile

      - name: Build storefront
        run: |
          cd storefront
          yarn build
        env:
          # Use placeholder values for build validation
          MEDUSA_BACKEND_URL: http://localhost:9000
          NEXT_PUBLIC_MEDUSA_BACKEND_URL: http://localhost:9000
          NEXT_PUBLIC_BASE_URL: http://localhost:8000
          NEXT_PUBLIC_MEDUSA_PUBLISHABLE_KEY: pk_placeholder_for_build_test
          NEXT_PUBLIC_DEFAULT_REGION: gb
          NEXT_PUBLIC_MINIO_ENDPOINT: localhost:9000
          NEXT_PUBLIC_SEARCH_ENDPOINT: http://localhost:7700
          NEXT_PUBLIC_INDEX_NAME: products

      - name: Validate build artifacts
        run: |
          if [ ! -d "storefront/.next" ]; then
            echo "Storefront build failed - .next directory not found"
            exit 1
          fi
          echo "âœ… Storefront build successful"

  # Deployment notification
  deploy-notification:
    name: Railway Deployment Status
    runs-on: ubuntu-latest
    needs: [validate-backend, validate-storefront]
    if: github.ref == 'refs/heads/main'

    steps:
      - name: Deployment Info
        run: |
          echo "âœ… Build validation passed!"
          echo ""
          echo "ðŸš‚ Railway will automatically deploy both services:"
          echo "   - Backend service will be deployed from /backend"
          echo "   - Storefront service will be deployed from /storefront"
          echo ""
          echo "ðŸ“‹ Make sure your Railway project is configured with:"
          echo "   - Backend service: Root directory = /backend"
          echo "   - Storefront service: Root directory = /storefront"
          echo "   - GitHub integration enabled"
          echo ""
          echo "ðŸ”— Check deployment status at: https://railway.app"
